<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>andy's blog</title>
	<meta name="description" content="">
	<meta name="author" content="andy.zhangtao">

	<!-- HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
		<script src="/theme/html5.js"></script>
	<![endif]-->

	<!-- Styles -->
	<link href="/theme/bootstrap.min.css" rel="stylesheet">
	<link href="/theme/local.css" rel="stylesheet">
	<link href="/theme/pygments.css" rel="stylesheet">

	<!-- Feeds -->
	<link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="andy's blog Atom Feed" />




<script>var _gaq=[['_setAccount','UA-71897460-1'],['_trackPageview']];(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.src='//www.google-analytics.com/ga.js';s.parentNode.insertBefore(g,s)}(document,'script'))</script>
<script type="text/javascript">
	var disqus_identifier = "mockkoa-yi-ge-ji-yu-koade-apice-shi-mo-ni-fu-wu-qi.html";
	(function() {
		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		dsq.src = 'http://andy-s-blog.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
</head>
<body>
	<div class="topbar">
	  <div class="topbar-inner">
		<div class="container-fluid">
		  <a class="brand" href="/">andy's blog</a>
			<ul class="nav">
					<li ><a href="/category/docker.html">Docker</a></li>
					<li class="active"><a href="/category/nodejs.html">Nodejs</a></li>
			</ul>
			<p class="pull-right"><a href="/archives.html">[archives]</a> <a href="/tags.html">[tags]</a></p>
		</div>
	  </div>
	</div>

	<div class="container-fluid">
	  <div class="sidebar">
		<div class="well">
			<h3>Blogroll</h3>
			<ul>
				<li><a href="http://getpelican.com/">Pelican</a></li>
				<li><a href="http://python.org/">Python.org</a></li>
				<li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
				<li><a href="#">You can modify those links in your config file</a></li>
			</ul>
			<div class="social">
			<h3>Social</h3>
			<ul>
				<li><a href="#">You can add links in your config file</a></li>
				<li><a href="#">Another social link</a></li>
			</ul>
			</div>
		</div>
	  </div>
	  <div class="content">
	<div class='article'>
		<div class="page-header"><h1>MockKoa - 一个基于Koa的API测试模拟服务器</h1></div>
		<div class="well small">Permalink: <a class="more" href="/mockkoa-yi-ge-ji-yu-koade-apice-shi-mo-ni-fu-wu-qi.html">2016-01-02 00:00:00+08:00</a>
by <a class="url fn" href="/author/andyzhangtao.html">andy.zhangtao </a>
 in <a href="/category/nodejs.html">Nodejs</a>
</div>
		<div><h1>MockKoa － 一个基于Koa的API测试服务器</h1>
<p>来自于andy的博客<a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#97;&#110;&#100;&#121;&#46;&#122;&#104;&#97;&#110;&#103;&#116;&#97;&#111;&#64;&#104;&#111;&#116;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;">&#97;&#110;&#100;&#121;&#46;&#122;&#104;&#97;&#110;&#103;&#116;&#97;&#111;&#64;&#104;&#111;&#116;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;</a></p>
<h2>MockKoa是什么？</h2>
<p>MockKoa是一个基于Koa＋nodejs的Rest API的测试服务器，说成是框架也可以，但我认为距离框架还有一些距离。</p>
<p>MockKoa使用nodejs来开发，通过Koa完成主要逻辑处理，可以加载以swagger为载体的API服务。(如果不了解swagger,<a href="www.swagger.io">请点击这里</a>)</p>
<p>目前MockKoa仅仅支持swagger格式，未来会考虑支持Yaml格式，但目前还没有具体时间安排。</p>
<h2>MockKoa可以做什么？</h2>
<p>MockKoa最重要的功能就是按照模拟策略生成API返回值，针对用户发起的每个API请求都可以生成唯一准确并且满足用户预期的返回值。</p>
<p>返回值包括：</p>
<ul>
<li>响应状态码</li>
<li>响应body数据</li>
<li>响应header数据</li>
</ul>
<h4>响应状态码</h4>
<p>MockKoa可以根据用户设定的模拟策略来返回指定的状态码。MockKoa支持多种模拟策略，并且支持一定的逻辑处理，但MockKoa不会自动生成状态码，这些状态码仍然需要用户明确指定。指定的方式可以是通过swagger文件指定或者通过用户自定义代码指定。</p>
<p>MockKoa在返回状态码时不会校验状态码是否有效，即便用户设定需要返回的响应码为601，MockKoa也会"乖顺"的返回此值。所以需要用户自行保证状态码是否有效。</p>
<p>同时，MockKoa不会处理重定向请求。对于重定向请求，需要客户端来处理，MockKoa模拟的是服务端，所以不需要处理重定向请求(有一些用户问过此问题，所以补充此处说明)。</p>
<h4>响应body数据</h4>
<p>MockKoa可以根据用户设定的body数据返回。 MockKoa默认设定Content—Type为<strong><em>*application/json</em></strong>*(有些用户问过很多次，这次也补充上)。如果用户需要返回其他类型，请自行设定。假设用户使用的是swagger文件，那么可以通过下面的代码进行指定。</p>
<div class="highlight"><pre>&quot;examples&quot;: {
              &quot;application/json&quot;: {
                &quot;folderId&quot;: 123456,
                &quot;createAt&quot;: &quot;2015-06-19T14:36:30&quot;,
                &quot;size&quot;: &quot;10KB&quot;
              }
            }
</pre></div>


<p>MockKoa同样不会检查用户所设定的Content-type是否有效，假设用户设定的Content-type是：<strong>app/json</strong>, MockKoa也会老老实实的返回。</p>
<p>用户设定Body数据有两种方式：</p>
<ol>
<li>通过在examples中指定返回数据。（实例如上）</li>
<li>通过在schema中指定返回数据。</li>
</ol>
<div class="highlight"><pre>&quot;definitions&quot;: {
    &quot;Pet&quot;: {
      &quot;properties&quot;: {
        &quot;name&quot;: {
          &quot;type&quot;: &quot;string&quot;
        },
        &quot;birthday&quot;: {
          &quot;type&quot;: &quot;integer&quot;,
          &quot;format&quot;: &quot;int32&quot;
        },
        &quot;company&quot;: {
          &quot;type&quot;: &quot;string&quot;
        },
        &quot;sex&quot;: {
          &quot;type&quot;: &quot;string&quot;
        }
      }
    }
  } 
</pre></div>


<p>MockKoa会自动生成5个Pet并且返回(5个是固定值，用户无法修改)。MockKoa在生成Pet时，会自动若干属性值，例如name，birthday，company，sex等等这些都会自动生成，除此之外，是会自动生成手机号(phone)，信用卡卡号(creditid)。但因为这些值都属于模拟计算得出，无法贴合实际情况，请用户知晓此点。</p>
<h4>响应Header数据</h4>
<p><strong>Header的处理未经充分测试，可能存在一些问题</strong>。MockKoa会按照用户所设定的Header值返回指定的Header，但因为时间关系，这部分未经充分测试，在解析swagger文件时可能会出现用户多处定义Header信息，但MockKoa只会返回其中某一处Header的情况。</p>
<h2>MockKoa有哪些模拟策略？</h2>
<p>MockKoa目前有5种模拟策略：</p>
<ol>
<li>固定值返回。</li>
<li>顺序返回。</li>
<li>随机返回。</li>
<li>按照不同权重返回。</li>
<li>按照用户自定义逻辑返回。</li>
</ol>
<h4>固定值返回</h4>
<p>这种策略是最简单的策略，用户在swagger文件中，通过mockConfig.json文件指定需要返回的数据。MockKoa再收到指定的API请求时，会按图索骥检索到需返回的数据然后返回给用户。</p>
<p>在使用这种策略时，用户需要保证mockConfig.json文件中所指定的数据一定在swagger文件中存在。</p>
<h4>顺序返回</h4>
<p>顺序返回策略比固定值策略跟进一步，假设用户为某个API设定了：“200”，“201”，“202”三种返回值。固定值只能三选一，返回一个。但顺序返回策略，可以依次返回。</p>
<p>这种策略大多数应用于单元测试，可以依次测试用户端所有代码是否都可以获得预期结果。</p>
<h4>随机返回</h4>
<p>随机返回相较于前两种策略，更加贴近于线上情况。同样假设用户为某个API设定了：“200”，“400”，“500”，“504”四种返回值。 随机返回策略可以针对每次的网络请求，自动选择其中一种返回值返回。</p>
<p>因此通过这种策略，可以基本满足QA环境中的测试需要。</p>
<p>但在大数据量(&gt;=100W)情景中，四种返回值总体返回概率几乎接近于1:1:1:1。如果400，500，504这样大量的出现，那么与实际线上情况会差距特别大。为了更加真实的接近线上情况，可以使用下面的模拟策略：</p>
<h4>按照权重返回</h4>
<p>我们为上述四种返回值设定不同的权重: 9:2:1:1。 同样经过100W网络请求下，MockKoa会返回69W次200，15W次400，500和504大致各出现8W次。以上数据均属于理论数据，按照统计数理论，每轮返回的数据都会有小幅波动，但总体出现比值会接近9:2:1:1。</p>
<p>通过这种策略，用户可以根据预估的线上情况设定不同的权重，来满足UAT环境测试需要。</p>
<h2>MockKoa有哪些不足？</h2>
<p>MockKoa目前处于Bate阶段，功能还有待完善。同时MockKoa目前没有UI，所有配置只能通过mockConfig.json来完全配置，每次修改mockConfig.json之后都需要重启MockKoa。</p>
<p>MockKoa UI Demo开发计划目前已经提上了开发日程，计划通过这个UI，可以让用户对MockKoa有个简单的认识，简化用户操作。</p>
<h2>如何下载MockKoa？</h2>
<p>用户可以通过访问<a href="https://github.com/andy-zhangtao/MockKoa">我的github</a>来获取最新的MockKoa。欢迎用户针对使用过程中发现的问题给我留言(<a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#97;&#110;&#100;&#121;&#46;&#122;&#104;&#97;&#110;&#103;&#116;&#97;&#111;&#64;&#104;&#111;&#116;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;">&#97;&#110;&#100;&#121;&#46;&#122;&#104;&#97;&#110;&#103;&#116;&#97;&#111;&#64;&#104;&#111;&#116;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;</a>).</p></div>
		<div>
			<h2>Comments</h2>
<div id="disqus_thread"></div>		<div>
	</div>
		<footer>
		  <p>Powered by <a href="http://getpelican.com/">Pelican</a>. Theme based on <a href="http://twitter.github.com/bootstrap/">Twitter Bootstrap</a>.</p>
		  <p>&copy; andy.zhangtao</p>
		</footer>
	  </div>

	</div>
</body>
</html>